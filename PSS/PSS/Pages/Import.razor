@page "/import"

<title>Import - PSS</title>
<link href="css/Import.css" rel="stylesheet">

@{
	if (allAbsPaths is null || allAbsPaths.Count is 0)
	{
		<h1>No supported files found in pss_upload.</h1>
		return;
	}
	
	importFiles = importFiles.OrderBy(file => file.renamedFilename).ToList();
	<div id="mainDiv">
		@for (int i = 0; i < importFiles.Count; i++)
		{
			if (i + 1 < importFiles.Count && importFiles[i].renamedFilename == importFiles[i + 1].renamedFilename)
			{
				importHasItemsWithSameName = true;
				
				<div class="errorDiv">
					@do
					{
						<div class="listItem">
							<img src=@(importFiles[i].thumbnail == null ? $"pss_import/{importFiles[i].shortPath}" : $"data:image/jpg;base64,{importFiles[i].thumbnail}") onclick="window.open('pss_import/@importFiles[i].shortPath', '_blank').focus();" alt="" loading="lazy"/>
							<span>@importFiles[i].shortPath</span>
							<input type="text">
						</div>
						i++;
					} while (i < importFiles.Count && importFiles[i - 1].renamedFilename == importFiles[i].renamedFilename);
				</div>
			}
			else
			{
				<div class="listItem">
					<img src=@(importFiles[i].thumbnail == null ? $"pss_import/{importFiles[i].shortPath}" : $"data:image/jpg;base64,{importFiles[i].thumbnail}") onclick="window.open('pss_import/@importFiles[i].shortPath', '_blank').focus();" alt="" loading="lazy"/>
					<span>@importFiles[i].shortPath</span>
				</div>
			}
		}
	</div>

	if (importHasItemsWithSameName)
		return;
	
	<span>shouldn't see me</span>
}

@code {

	///Stores the absolute path of every supported file in pss_import.
	private static List<string> allAbsPaths;

	///List of data about each supported file in pss_import.
	private static List<ImportFile> importFiles;

	///If pss_import contains files with the same name but in different folders, make sure the user fixes this first as it will most likely cause problems when the items get added to pss_library.
	private static bool importHasItemsWithSameName = false;

	protected override async Task OnInitializedAsync()
	{
		allAbsPaths = F.GetSupportedFiles(S.importFolderPath);
		importFiles = new List<ImportFile>(allAbsPaths.Count);

		await Parallel.ForEachAsync(allAbsPaths, async (absPath, _) =>
		{
			ImportFile importFile = new(absPath);
			importFiles.Add(importFile);
		});

		
	}

}